import SPM from '@ali/universal-spm';

export function getSpmUrl(url, spmC, spmD) {
  if (url !== undefined && spmC !== undefined && spmD !== undefined) {
    let queryIndex = url.indexOf('?');
    // 过滤url 自带的 spm query参数
    if (queryIndex !== -1 && url.indexOf('spm=') !== -1) {
      const arr = url.slice(queryIndex + 1).split('&');
      const filterArr = arr.filter(a => a.indexOf('spm=') === -1);
      if (filterArr.length === 0) {
        url = url.slice(0, queryIndex);
        queryIndex = -1;
      } else {
        url = url.slice(0, queryIndex + 1) + filterArr.join('&');
      }
    }
    url = `${url}${queryIndex > -1 ? '&' : '?'}${SPM.getSPMQueryString(spmC, spmD)}`;
  }
  return url;
}

/**
 * @deprecated 可以由页面自己去 import query-string 模块
 * @returns {URLSearchParams}
 */
export function getParam() {
  const s = location.href.split('?');
  return new URLSearchParams(location.search.substring(1) || (s[1] || ''));
}

/**
 * 
 * @param {string} key  参数名
 * @param {string} value 参数值
 * @param {string} url 
 * @return {url}
 */
export function updateQueryString(key, value, url) {
  if (!url) url = location.href;
  let re = new RegExp("([?&])" + key + "=.*?(&|#|$)(.*)", "gi"),
    hash;
  if (re.test(url)) {
    if (typeof value !== 'undefined' && value !== null) {
      return url.replace(re, '$1' + key + "=" + value + '$2$3');
    } else {
      hash = url.split('#');
      url = hash[0].replace(re, '$1$3').replace(/(&|\?)$/, '');
      if (typeof hash[1] !== 'undefined' && hash[1] !== null) {
        url += '#' + hash[1];
      }
      return url;
    }
  }
  else {
    if (typeof value !== 'undefined' && value !== null) {
      const separator = url.indexOf('?') !== -1 ? '&' : '?';
      hash = url.split('#');
      url = hash[0] + separator + key + '=' + value;
      if (typeof hash[1] !== 'undefined' && hash[1] !== null) {
        url += '#' + hash[1];
      }
      return url;
    }
    else {
      return url;
    }
  }
}