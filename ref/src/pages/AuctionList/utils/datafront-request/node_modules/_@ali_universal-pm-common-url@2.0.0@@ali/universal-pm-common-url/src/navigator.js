import { isWeex } from 'universal-env';
import windvane from '@ali/universal-windvane';
import { createTrackUrl } from "@ali/universal-pm-track";

import { getSpmUrl } from './url';

export function replace(url, spmc, spmd, track = true) {
  url = getSpmUrl(url, spmc, spmd);
  if (track) url = createTrackUrl({ url, spmc, spmd });
  let location = {};
  if (isWeex) {
    if (url.indexOf('wh_weex=true') < 0) {
      url += `${url.indexOf('?') > -1 ? '&' : '?'}wh_weex=true`;
    }
    location = require('@weex-module/location');
    if (!location || !location.replace) {
      location = {
        replace: openNewPage,
      };
    }
  } else {
    location = window.location;
  }
  location.replace(url);
}

export function openTel(telNum) {
  const tel = `tel:${telNum}`;
  if (isWeex) {
    const navigator = require('@weex-module/navigator');
    navigator.open({
      url: tel,
    });
  } else {
    window.location.href = tel;
  }
}

/**
 * 导航到新页面
 */
export function openNewPage(url, spmc, spmd, self = false, track = true) {
  open({
    url,
    spmc,
    spmd,
    self,
    track
  });
}

export function open({ url, spmc, spmd, self = false, track = true, ab = '0' }) {
  url = getSpmUrl(url, spmc, spmd);
  if (track) url = createTrackUrl({ url, spmc, spmd, ab });
  if (!self || isWeex) {
    windvane.call(
      'Base',
      'openWindow',
      {
        url,
      },
      e => {
        if (JSON.parse(e).ret !== 'HY_SUCCESS') {
          if (isWeex) {
            window.open(url);
          } else {
            window.location.href = url;
          }
        }
      },
      () => {
        window.location.href = url;
      }
    );
  } else {
    window.location.href = url;
  }
}